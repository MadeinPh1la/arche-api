name: Update issue status from PRs

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - edited

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  mark_issues_in_progress:
    runs-on: ubuntu-latest

    steps:
      - name: Add status:in_progress label to referenced issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";
            const title = pr.title || "";
            const text = `${title}\n${body}`;

            // 1) Prefer closing keywords (Fixes #13, Closes #13, Resolves #13, etc.)
            const closingRegex = /\b(?:close[sd]?|fix(e[sd])?|resolve[sd]?)\b[^\S\r\n]+#(\d+)/gi;
            const issueNumbers = new Set();

            let match;
            while ((match = closingRegex.exec(text)) !== null) {
              issueNumbers.add(parseInt(match[1], 10));
            }

            // 2) Fallback: plain #123 references (if you want this behavior)
            if (issueNumbers.size === 0) {
              const bareRefRegex = /#(\d+)/g;
              while ((match = bareRefRegex.exec(text)) !== null) {
                issueNumbers.add(parseInt(match[1], 10));
              }
            }

            if (issueNumbers.size === 0) {
              core.info("No issue references found in PR title/body â€“ nothing to label.");
              return;
            }

            core.info(`Found referenced issues: ${[...issueNumbers].join(", ")}`);

            for (const number of issueNumbers) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  labels: ["status:in_progress"],
                });
                core.info(`Applied status:in_progress to issue #${number}`);
              } catch (error) {
                core.warning(`Failed to label issue #${number}: ${error.message}`);
              }
            }
