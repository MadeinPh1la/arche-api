name: CI

on:
  push:
    branches: [ main, setup ]
  pull_request:
    branches: [ main, setup ]
  workflow_dispatch: {}  # manual runs

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    name: Lint • Type • Test (Py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: stacklion
          POSTGRES_PASSWORD: stacklion
          POSTGRES_DB: stacklion_test
        ports: [ "5432:5432" ]
        options: >-
          --health-cmd="pg_isready -U stacklion -d stacklion_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      redis:
        image: redis:7
        ports: [ "6379:6379" ]
        options: >-
          --health-cmd="redis-cli ping || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      # Runtime env for the app under test
      ENVIRONMENT: test
      LOG_LEVEL: INFO
      DATABASE_URL: postgresql+asyncpg://stacklion:stacklion@127.0.0.1:5432/stacklion_test
      TEST_DATABASE_URL: postgresql+asyncpg://stacklion:stacklion@127.0.0.1:5432/stacklion_test
      REDIS_URL: redis://127.0.0.1:6379/2
      AUTH_ENABLED: "false"
      RATE_LIMIT_ENABLED: "false"
      ALLOWED_ORIGINS: "*"

    steps:
      - name: Checkout (PR head or push ref)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Show Python info (debug)
        run: |
          python -V
          which python
          pip -V

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          # Ensure the project itself is importable with dev + otel extras
          if [ -f pyproject.toml ] || [ -f setup.cfg ] || [ -f setup.py ]; then
            pip install -e ".[dev,otel]" || pip install -e .
          fi

      - name: Wait for Postgres (belt & suspenders)
        run: |
          for i in {1..30}; do
            pg_isready -h 127.0.0.1 -p 5432 -d stacklion_test -U stacklion && break
            sleep 1
          done

      - name: Bootstrap test database schema (minimal tables for tests)
        run: |
          python - << 'PY'
          import asyncio
          import os

          from sqlalchemy import text
          from sqlalchemy.ext.asyncio import create_async_engine

          async def main() -> None:
              database_url = os.environ["DATABASE_URL"]
              engine = create_async_engine(database_url)

              async with engine.begin() as conn:
                  # Ensure staging schema exists
                  await conn.execute(text("CREATE SCHEMA IF NOT EXISTS staging"))

                  # Minimal md_intraday_bars_parent table for intraday bar tests
                  await conn.execute(
                      text(
                          """
                          CREATE TABLE IF NOT EXISTS md_intraday_bars_parent (
                              symbol_id UUID NOT NULL,
                              ts TIMESTAMPTZ NOT NULL,
                              open NUMERIC(20, 8) NOT NULL,
                              high NUMERIC(20, 8) NOT NULL,
                              low NUMERIC(20, 8) NOT NULL,
                              close NUMERIC(20, 8) NOT NULL,
                              volume NUMERIC(38, 0) NOT NULL,
                              provider VARCHAR NOT NULL,
                              PRIMARY KEY (symbol_id, ts)
                          )
                          """
                      )
                  )

                  # Minimal staging.ingest_runs table for ingest use case tests
                  await conn.execute(
                      text(
                          """
                          CREATE TABLE IF NOT EXISTS staging.ingest_runs (
                              run_id UUID PRIMARY KEY,
                              source VARCHAR NOT NULL,
                              endpoint VARCHAR NOT NULL,
                              key VARCHAR NOT NULL,
                              started_at TIMESTAMPTZ NOT NULL,
                              finished_at TIMESTAMPTZ,
                              result VARCHAR,
                              error_reason VARCHAR
                          )
                          """
                      )
                  )

                  # Minimal staging.raw_payloads table for ingest staging payloads
                  await conn.execute(
                      text(
                          """
                          CREATE TABLE IF NOT EXISTS staging.raw_payloads (
                              payload_id UUID PRIMARY KEY,
                              source VARCHAR NOT NULL,
                              endpoint VARCHAR NOT NULL,
                              symbol_or_cik VARCHAR NOT NULL,
                              as_of TIMESTAMPTZ,
                              window_from TIMESTAMPTZ,
                              window_to TIMESTAMPTZ,
                              etag VARCHAR,
                              received_at TIMESTAMPTZ NOT NULL,
                              payload JSON NOT NULL
                          )
                          """
                      )
                  )

              await engine.dispose()

          asyncio.run(main())
          PY

      - name: Format (black --check)
        run: black --check --diff .

      - name: Lint (ruff)
        run: ruff check .

      - name: Type check (mypy)
        run: mypy -p stacklion_api -p tests

      - name: Run tests (pytest, quiet)
        id: pytest_quiet
        run: python -m pytest -q

      - name: Upload pytest artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-failures
          path: |
            .pytest_cache
            tests/**/__snapshots__/*.json
            **/pytest-*.log
          if-no-files-found: ignore

      - name: Run tests with coverage
        if: ${{ steps.pytest_quiet.outcome == 'success' }}
        id: pytest_cov
        run: |
          pytest \
            --cov=src/stacklion_api \
            --cov=tests \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html

      - name: Upload coverage.xml
        if: ${{ steps.pytest_cov.outcome == 'success' && hashFiles('coverage.xml') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Upload HTML coverage
        if: ${{ steps.pytest_cov.outcome == 'success' && hashFiles('htmlcov/index.html') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: htmlcov
          path: htmlcov
