name: CI

on:
  push:
    branches: [ main, setup ]
  pull_request:
    branches: [ main, setup ]
  workflow_dispatch: {}  # manual runs

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    name: Lint • Type • Test (Py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: stacklion
          POSTGRES_PASSWORD: stacklion
          POSTGRES_DB: stacklion_test
        ports: [ "5432:5432" ]
        options: >-
          --health-cmd="pg_isready -U stacklion -d stacklion_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      redis:
        image: redis:7
        ports: [ "6379:6379" ]
        options: >-
          --health-cmd="redis-cli ping || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      # ====================================================================
      # Test environment identity (mirrors .env.tests)
      # ====================================================================
      ENVIRONMENT: test
      SERVICE_NAME: stacklion-api
      SERVICE_VERSION: "0.0.0"
      LOG_LEVEL: WARNING

      # HTTP / CORS
      ALLOWED_ORIGINS: "*"

      # ====================================================================
      # Database / cache (local + CI friendly)
      # ====================================================================
      DATABASE_URL: postgresql+asyncpg://stacklion:stacklion@127.0.0.1:5432/stacklion_test
      TEST_DATABASE_URL: postgresql+asyncpg://stacklion:stacklion@127.0.0.1:5432/stacklion_test
      REDIS_URL: redis://127.0.0.1:6379/2

      # Celery (if used in tests)
      CELERY_BROKER_URL: redis://127.0.0.1:6379/2
      CELERY_RESULT_BACKEND: redis://127.0.0.1:6379/3

      # ====================================================================
      # External providers (test/stub keys)
      # ====================================================================
      MARKETSTACK_API_KEY: __test__
      EDGAR_BASE_URL: https://data.sec.gov

      # ====================================================================
      # Rate limiting (typically disabled in tests)
      # ====================================================================
      RATE_LIMIT_ENABLED: "false"
      RATE_LIMIT_BACKEND: memory
      RATE_LIMIT_BURST: "5"
      RATE_LIMIT_WINDOW_SECONDS: "1"

      # ====================================================================
      # Auth (HS256 test mode)
      # ====================================================================
      AUTH_ENABLED: "false"
      AUTH_ALGORITHM: HS256
      AUTH_HS256_SECRET: test-secret

      # ====================================================================
      # OpenTelemetry (off in unit/integration tests)
      # ====================================================================
      OTEL_ENABLED: "false"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://127.0.0.1:4317

      # ====================================================================
      # Clerk (dummy test configuration)
      # ====================================================================
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_stacklion_test
      CLERK_SECRET_KEY: sk_test_stacklion_test
      CLERK_ISSUER: https://stacklion-test.clerk.accounts.dev
      CLERK_AUDIENCE: stacklion-api
      CLERK_JWKS_URL: https://stacklion-test.clerk.accounts.dev/.well-known/jwks.json
      CLERK_WEBHOOK_SECRET: whsec_test

    steps:
      - name: Checkout (PR head or push ref)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Show Python info (debug)
        run: |
          python -V
          which python
          pip -V

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Single source of truth: pyproject extras
          pip install -e ".[dev,otel]"

      - name: Wait for Postgres (belt & suspenders)
        run: |
          for i in {1..30}; do
            pg_isready -h 127.0.0.1 -p 5432 -d stacklion_test -U stacklion && break
            sleep 1
          done

      - name: Bootstrap test database schema (minimal tables for tests)
        run: |
          python - << 'PY'
          import asyncio
          import os

          from sqlalchemy import text
          from sqlalchemy.ext.asyncio import create_async_engine

          async def main() -> None:
              database_url = os.environ["DATABASE_URL"]
              engine = create_async_engine(database_url)

              async with engine.begin() as conn:
                  # Ensure staging schema exists
                  await conn.execute(text("CREATE SCHEMA IF NOT EXISTS staging"))

                  # Minimal md_intraday_bars_parent table for intraday bar tests
                  await conn.execute(
                      text(
                          """
                          CREATE TABLE IF NOT EXISTS md_intraday_bars_parent (
                              symbol_id UUID NOT NULL,
                              ts TIMESTAMPTZ NOT NULL,
                              open NUMERIC(20, 8) NOT NULL,
                              high NUMERIC(20, 8) NOT NULL,
                              low NUMERIC(20, 8) NOT NULL,
                              close NUMERIC(20, 8) NOT NULL,
                              volume NUMERIC(38, 0) NOT NULL,
                              provider VARCHAR NOT NULL,
                              PRIMARY KEY (symbol_id, ts)
                          )
                          """
                      )
                  )

                  # Minimal staging.ingest_runs table for ingest use case tests
                  await conn.execute(
                      text(
                          """
                          CREATE TABLE IF NOT EXISTS staging.ingest_runs (
                              run_id UUID PRIMARY KEY,
                              source VARCHAR NOT NULL,
                              endpoint VARCHAR NOT NULL,
                              key VARCHAR NOT NULL,
                              started_at TIMESTAMPTZ NOT NULL,
                              finished_at TIMESTAMPTZ,
                              result VARCHAR,
                              error_reason VARCHAR
                          )
                          """
                      )
                  )

                  # Minimal staging.raw_payloads table for ingest staging payloads
                  await conn.execute(
                      text(
                          """
                          CREATE TABLE IF NOT EXISTS staging.raw_payloads (
                              payload_id UUID PRIMARY KEY,
                              source VARCHAR NOT NULL,
                              endpoint VARCHAR NOT NULL,
                              symbol_or_cik VARCHAR NOT NULL,
                              as_of TIMESTAMPTZ,
                              window_from TIMESTAMPTZ,
                              window_to TIMESTAMPTZ,
                              etag VARCHAR,
                              received_at TIMESTAMPTZ NOT NULL,
                              payload JSON NOT NULL
                          )
                          """
                      )
                  )

              await engine.dispose()

          asyncio.run(main())
          PY

      - name: CI harness (black • ruff • mypy • pytest)
        run: bash scripts/ci.sh

      - name: Upload pytest artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-failures
          path: |
            .pytest_cache
            tests/openapi/snapshots/openapi.json
            **/pytest-*.log
          if-no-files-found: ignore

      - name: Upload coverage.xml
        if: always() && hashFiles('coverage.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Upload HTML coverage
        if: always() && hashFiles('htmlcov/index.html') != ''
        uses: actions/upload-artifact@v4
        with:
          name: htmlcov
          path: htmlcov
